{% extends "base.html" %}
<!-- {% import "bootstrap/wtf.html" as wtf %} -->

{% block title %}
LOT Polish Airlines Dashboard
{% endblock %}

{% block app_styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
{% endblock %}

{% block app_content %}
	<div class="row">
        <div class="col-md-7">
            <h1>Route Dashboard</h1>
        </div>
    </div>
    {% if form %}
    <div class="row">
        <div class="col-md-4">
            <form class="form" action="/routes" method="post" id="route">
                {{ wtf.form_errors(form) }}
                {{ wtf.form_field(form.airline) }}
                {{ wtf.form_field(form.origin) }}
                {{ wtf.form_field(form.destination) }}
                {{ wtf.form_field(form.year) }}
                {{ wtf.form_field(form.submit) }}
                {{ form.hidden_tag() }}
            </form>
        </div>
    </div>
    {% endif %}

    {% if data %}
    <div class="row">
        <div class="col-md-6">
            <h2>{{origin_city_name}} to {{destination_city_name}} Passenger Counts</h2>
            <canvas id="myChart"></canvas>
        </div>

        <div class="col-md-6">
            <h2>Map</h2>
            <br>
            <div id="mapid" style="width: 100%; height: 400px;"></div>
        </div>

    </div>

    <br>
    <hr>
    <br>
    <div class = "row">
        <div class="col-md-8">
        <h2>Raw Data</h2>
        <table class="table">
          	<thead>
                <tr>
                	<th scope="col">Airline</th>
                	<th scope="col">Month</th>
                	<th scope="col">Origin</th>
                	<th scope="col">Dest</th>
                    <th scope="col">Departures</th>
            		<th scope="col">Seats</th>
            		<th scope="col">Passengers</th>
                    <th scope="col">Load Factor (%)</th>
                </tr>
          	</thead>
          	<tbody>
              	{% for item in data %}
                <tr>
                	<td>{{ item[0] }}</td>
                	<td>{{ item[1] }}</td>
                	<td>{{ item[2] }}</td>
                	<td>{{ item[3] }}</td>
                	<td>{{ item[4] }}</td>
                	<td>{{ item[5] }}</td>
                    <td>{{ item[6] }}</td>
                    {% if item[7] %}
                    <td>{{ '%0.1f%%' % (item[7]*100|float) }}</td>
                    {% else %}
                    <td></td>
                    {% endif %}
                </tr>
            	{% endfor %}
          </tbody>
        </table>
        </div>
    </div>
    {% endif %}

{% endblock %}

{%block app_scripts %}
<script>

let airline_select = document.getElementById('airline');
let origin_select = document.getElementById('origin');
let destination_select = document.getElementById('destination');
let year_select = document.getElementById('year');

window.onload = function() {
    
    // alert('it worked');
    fetch('/airline').then(function(response){
        response.json().then(function(data){
            console.log(data)
            let optionHTML = '';
            // alert(data.airlines[0].id)
            for (let airline of data.airlines){
                optionHTML += '<option value="' + airline.id+'">' + airline.carrier_name +' (' + airline.carrier + ')</option>';
            }
        airline_select.innerHTML = optionHTML;
        airline_select.onchange();
        });
    });
}

airline_select.onchange = function(){
    origin_select.innerHTML = '';
    destination_select.innerHTML = '';
    year_select.innerHTML = '';

    airline = airline_select.value;
    
    fetch('/airline/' + airline).then(function(response){
        response.json().then(function(data){
            console.log(data)
            let optionHTML = '';
            for (let origin of data.origins){
                optionHTML += '<option value="' + origin.id +'">' + origin.city_name +' (' + origin.code + ')</option>';
            }
        origin_select.innerHTML = optionHTML;
        origin_select.onchange();
        });
    });
}

origin_select.onchange = function() {
    // Reset lower values
    destination_select.innerHTML = '';
    year_select.innerHTML = '';

    airline = airline_select.value;
    origin = origin_select.value;

    fetch('/airline/' + airline + '/' + origin).then(function(response){
        response.json().then(function(data){
            console.log(data)
            let optionHTML = '';
            for (let destination of data.destinations){
                optionHTML += '<option value="' + destination.id +'">' + destination.city_name +' (' + destination.code + ')</option>';
            }
        destination_select.innerHTML = optionHTML;
        destination_select.onchange();
        });
    });
}

destination_select.onchange = function() {
    year_select.innerHTML = '';

    airline = airline_select.value;
    origin = origin_select.value;
    destination = destination_select.value;

    fetch('/airline/' + airline + '/' + origin + '/' + destination).then(function(response){
        response.json().then(function(data){
            console.log(data)
            let optionHTML = '';
            for (let year of data.years){
                optionHTML += '<option value="' + year.year +'">' + year.year + '</option>';
            }
        year_select.innerHTML = optionHTML;
        year = year_select.value;
        // alert("airline: " + airline + " origin: " + origin + " destination: " + destination + " year: " + year);
        });
    });

}

</script>
    <script>

    var mymap = L.map('mapid').setView([54.571309, -22.850261], 2);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
            '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(mymap);

    L.marker([{{origin_lat}}, {{origin_lng}}]).addTo(mymap)
        .bindPopup("<b>KRK</b><br />Kraków Airport.");

    L.marker([{{destination_lat}}, {{destination_lng}}]).addTo(mymap)
        .bindPopup("<b>ORD</b><br />Chicago O'Hare");

    L.polygon([
        [{{origin_lat}}, {{origin_lng}}],
        [{{destination_lat}}, {{destination_lng}}]
    ]).addTo(mymap).bindPopup("I am KRK-ORD");


    // var popup = L.popup();

    // function onMapClick(e) {
    //     popup
    //         .setLatLng(e.latlng)
    //         .setContent("You clicked the map at " + e.latlng.toString())
    //         .openOn(mymap);
    // }

    // mymap.on('click', onMapClick);

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <script>
        var ctx = document.getElementById('myChart').getContext('2d');
        var chart = new Chart(ctx, {
        // The type of chart we want to create

    // The data for our dataset
        type: 'bar',
        data: {
            labels: [{% for item in months %}
                  "{{ item[0] }}", //tuple handling
              {% endfor %}],
            datasets: [{
                type: 'bar',
                label: "Seats",
                // backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'gray',
                data: [{% for item in seats %}
                      {{ item[0] }},
                    {% endfor %}],
            },{
                type: 'line',
                label: "{{origin_city_code}}-{{destination_city_code}}",
                // backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                fill: false,
                data: [{% for item in pax %}
                      {{ item[0] }},
                    {% endfor %}],
            },{
                type: 'line',
                label: "{{destination_city_code}}-{{origin_city_code}}",
                // backgroundColor: 'cyan',
                borderColor: 'blue',
                fill: false,
                data: [{% for item in paxreverse %}
                      {{ item[0] }},
                    {% endfor %}],
            }]
        },

    // Configuration options go here
        options: {}
    });
    </script>
{% endblock %}